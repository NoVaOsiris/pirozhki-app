<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админка - Продажи пирожков</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    input, select { margin: 10px 0; padding: 5px; }
    button { padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Отчёт по продажам пирожков</h2>

  <label>
    Фильтр по дате: 
    <input type="date" id="dateFilter" />
  </label>

  <label>
    Фильтр по товару: 
    <select id="itemFilter">
      <option value="">Все</option>
      <option value="Пирожок с мясом">Пирожок с мясом</option>
      <option value="Пирожок с капустой">Пирожок с капустой</option>
    </select>
  </label>

  <button onclick="loadSales()">Обновить</button>
  <button onclick="exportCSV()">Экспорт в CSV</button>

  <table id="salesTable">
    <thead>
      <tr>
        <th>Время</th>
        <th>Товар</th>
        <th>Количество</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadSales() {
      const dateFilter = document.getElementById('dateFilter').value;
      const itemFilter = document.getElementById('itemFilter').value;

      let response = await fetch('/admin');
      let sales = await response.json();

      // Фильтрация по дате и товару
      if (dateFilter) {
        sales = sales.filter(sale => sale.time.startsWith(dateFilter));
      }
      if (itemFilter) {
        sales = sales.filter(sale => sale.item === itemFilter);
      }

      const tbody = document.querySelector('#salesTable tbody');
      tbody.innerHTML = '';

      sales.forEach(sale => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(sale.time).toLocaleString('ru-RU')}</td>
          <td>${sale.item}</td>
          <td>${sale.quantity}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function exportCSV() {
      const rows = [];
      const headers = ['Время', 'Товар', 'Количество'];
      rows.push(headers.join(';'));

      const tbody = document.querySelector('#salesTable tbody');
      for (const row of tbody.rows) {
        const cols = [];
        for (const cell of row.cells) {
          cols.push('"' + cell.innerText + '"');
        }
        rows.push(cols.join(';'));
      }

      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'sales_report.csv';
      link.click();
    }

    // Загружаем данные при открытии страницы
    loadSales();
  </script>
</body>
</html>
